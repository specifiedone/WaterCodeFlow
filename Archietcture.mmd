graph TB
    subgraph Input["Program Execution"]
        CODE[Python Source Code]
    end
    
    subgraph Capture["Layer 1: Event Capture"]
        TRACER[sys.settrace Handler]
        TENSOR_HOOK[Tensor Operation Hook]
        
        CODE --> TRACER
        CODE --> TENSOR_HOOK
        
        TRACER --> |line, call, return, exception| EVENT_BUILDER
        TENSOR_HOOK --> |tensor ops, mutations| EVENT_BUILDER
        
        EVENT_BUILDER[Event Builder<br/>Creates structured events]
    end
    
    subgraph Stream["Layer 2: Event Stream"]
        EVENT_BUILDER --> QUEUE[In-Memory Queue<br/>FIFO buffer]
        QUEUE --> SERIALIZER[Binary Serializer<br/>msgpack/protobuf]
    end
    
    subgraph Analysis["Layer 3: State Analysis"]
        SERIALIZER --> DISPATCHER[Event Dispatcher]
        
        DISPATCHER --> VAR_TRACKER[Variable State Tracker<br/>Maintains current values]
        DISPATCHER --> TENSOR_TRACKER[Tensor State Tracker<br/>Fingerprints + metadata]
        
        VAR_TRACKER --> |current state| DIFF_ENGINE
        TENSOR_TRACKER --> |current state| DIFF_ENGINE
        
        DIFF_ENGINE[Delta Calculator<br/>Computes state changes]
        
        DIFF_ENGINE --> |primitives| PRIM_DIFF[Primitive Differ]
        DIFF_ENGINE --> |collections| STRUCT_DIFF[Structural Differ]
        DIFF_ENGINE --> |tensors| TENSOR_DIFF[Tensor Block Differ]
    end
    
    subgraph Storage["Layer 4: Persistent Storage"]
        PRIM_DIFF --> WRITER
        STRUCT_DIFF --> WRITER
        TENSOR_DIFF --> WRITER
        
        WRITER[Storage Writer<br/>Batched writes] --> DB[(Timeline Database<br/>LMDB)]
        
        DB --> IDX_TIME[Timestamp Index]
        DB --> IDX_VAR[Variable Index]
        DB --> IDX_FRAME[Frame Index]
    end
    
    subgraph Query["Layer 5: Timeline Query"]
        DB --> READER[Timeline Reader]
        
        READER --> LOOKUP[Point Lookup<br/>Get state at time T]
        READER --> RANGE[Range Query<br/>Get states T1 to T2]
        READER --> SEARCH[Search Query<br/>Find when X changed]
    end
    
    subgraph Replay["Layer 6: State Reconstruction"]
        LOOKUP --> RECONSTRUCTOR[State Reconstructor]
        RANGE --> RECONSTRUCTOR
        
        RECONSTRUCTOR --> FWD[Forward Builder<br/>Apply deltas forward]
        RECONSTRUCTOR --> REV[Reverse Builder<br/>Invert deltas backward]
        
        FWD --> RESULT[Reconstructed State]
        REV --> RESULT
    end
    
    subgraph Output["API Interface"]
        RESULT --> API[Python API<br/>flow.goto, flow.inspect<br/>flow.diff, flow.replay]
    end
    
    style Input fill:#e3f2fd
    style Capture fill:#fff3e0
    style Stream fill:#f3e5f5
    style Analysis fill:#e8f5e9
    style Storage fill:#fce4ec
    style Query fill:#e0f2f1
    style Replay fill:#fff9c4
    style Output fill:#ede7f6
    
    classDef processNode fill:#90caf9,stroke:#1976d2,stroke-width:2px
    classDef dataNode fill:#a5d6a7,stroke:#388e3c,stroke-width:2px
    classDef storageNode fill:#ce93d8,stroke:#7b1fa2,stroke-width:2px
    
    class TRACER,TENSOR_HOOK,EVENT_BUILDER,DIFF_ENGINE processNode
    class QUEUE,DB dataNode
    class WRITER,READER storageNode
